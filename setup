#!/bin/bash
################################################################################
# setup
# This script creates symlinks from $HOME to the committed files in $HOME/dotfiles
################################################################################

# Variables
cdir=$(pwd)
storage=$cdir/old # storage
basedir=${cdir##*/} # current top-level name
files=($(git ls-tree --name-only master)) # get list of committed files

# Create storage for old dotfiles
echo "Creating $storage for backup of any existing dotfiles..."
[ ! -d $storage ] && mkdir $storage

# Move existing stuff to storage, then create symlinks 
# Only move if the item itself is not a symlink
# Also no longer reference home, for special case of sharing home directory
# with external server linked indirectlry (e.g. euclid to gauss)
for file in ${files[@]}; do # iterate through files
  if [ $file != "setup" ] && [ $file != ".gitignore" ]; then
    echo "Creating symlink to $file in $(realpath ../)..."
    # Be conservative
    if [ -L ../$file ]; then
      rm ../$file # remove if symlink
    elif [ -r ../$file ]; then
      echo "Moving existing file \"$file\" to $storage..."
      mv -r ../$file $storage/ # copy if not
    fi
    # Finally create symlink
    # Make sure source-file is path RELATIVE to current location
    ln -s $basedir/$file ../$file
  fi
done
