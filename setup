#!/bin/bash
################################################################################
# setup
# This script creates symlinks from $HOME to the committed files in $HOME/dotfiles
################################################################################

# Variables
curdir=~/dotfiles
olddir=~/dotfiles/old
files=($(git ls-tree --name-only master)) # get list of committed files

# Create storage for old dotfiles
echo "Creating $olddir for backup of any existing dotfiles..."
[ ! -d $olddir ] && mkdir $olddir

# Change to the dotfiles directory
echo "Changing to the $curdir directory..."
cd $curdir

# Move existing stuff to storage, then create symlinks 
# Only move if the item itself is not a symlink
echo "Moving any existing dotfiles from $HOME to $olddir..."
for file in ${files[@]}; do # iterate through files
  if [ $file != "setup" ] && [ $file != ".gitignore" ]; then
    echo "Creating symlink to $file in $HOME..."
    # Be conservative
    if [ -L $HOME/$file ]; then
      rm $HOME/$file # remove if symlink
    elif [ -r $HOME/$file ]; then
      mv -r $HOME/$file $olddir/ # copy if not
    fi
    # Finally create symlink
    ln -sh $curdir/$file $HOME/$file
  fi
done
