#!/usr/bin/env bash
#-----------------------------------------------------------------------------#
# Sync a local directory with files on SD card
# This function will only modify files on the SD card, never the local
# directory. Beware problem that files are 'modified' when transferred to
# SD card, so cannot check dates on them.
#-----------------------------------------------------------------------------#
shopt -u nullglob
raise() {
  echo "Error: $@"
  exit 1
}
cp='gcp --preserve=mode,timestamps' # simpler and faster than rsync
mb_folder="$HOME/playlist"
if [ -d "$HOME/Phone/Card/Playlist" ]; then
  sd_folder="$HOME/Phone/Card/Playlist"  # old phone
else
  sd_folder="$HOME/Phone/Music"  # new phone
fi
sync_modified=true  # include files?
[ -d "$sd_folder" ] || raise "Phone must be mounted with simple-mtpfs."
echo "SD playlist: $sd_folder"
echo "MB playlist: $mb_folder"

# Iterate through local files
copied=false  # copied anything?
updated=false # updated anything?
deleted=false # deleted anything?
for path in "$mb_folder/"*.{m3u8,mp3,m4a}; do
  ! [ -r "$path" ] && continue # e.g. if glob failed
  file="${path##*/}"
  # Alphabetical order and fix carriage returns
  # See: https://unix.stackexchange.com/a/32059/112647
  if [[ "$file" =~ '.m3u8' ]]; then
    python - <<EOF
import os
with open("$path", 'r') as f:
    lines = [line.strip() for line in f.readlines()]
header = lines[0]  # should be #EXTM3U
pairs = zip(lines[1::2], (os.path.basename(path) for path in lines[2::2]))
pairs = sorted(pairs, key=lambda x: x[1].lower())
file = header + '\n' + '\n'.join(line for lines in pairs for line in lines)
with open("$path", 'w') as f:
    f.write(file)
EOF
  fi
  # Copy new files downloaded
  if ! [ -r "$sd_folder/$file" ]; then
    copied=true # record
    echo "New local file: $file. Copying to SD..."
    $cp "$path" "$sd_folder/$file"
    [ $? -eq 0 ] || raise "Copy failed."
  # Replace old file of same name with modified one
  elif $sync_modified; then
    if ! [ -r "$mb_folder/sd.log" ]; then
      confirm "Warning: sd.log not found! Cancel psync?" # call script to confirm
      [ $? -ne 0 ] && exit 1
      touch "$mb_folder/sd.log" # if doesn't exist, make
    fi
    date_c=$(tail -n 1 "$mb_folder/sd.log")  # date copied to SD
    date_m=$(date -r "$path" +%s)  # date last modified
    if [ -z "$date_c" ]; then  # initializing directory
      if [ $date_m -gt $(($(date +%s) - (50*3600*24))) ]; then # update stuff changed within 50 days
        modified=true
      else
        modified=false
      fi
    elif [ "$date_m" -gt "$date_c" ]; then
      modified=true # modified since last copied
    else
      modified=false # not modified since last copied
    fi
    if $modified; then
      echo "Modified local file \"$file\" since previous sync."
      updated=true
      $cp "$path" "$sd_folder/$file"
      [ $? -eq 0 ] || raise "Copy failed."
    fi
  fi
done
$copied  || echo "No new files found."
$updated || echo "No recently modified files found."

# Iterate through remote files
for path in "$sd_folder/"*.{mp3,m4a,m3u8}; do
  ! [ -r "$path" ] && continue # e.g. if glob failed
  file="${path##*/}"
  if ! [ -r "$mb_folder/$file" ]; then
    # Delete old file
    deleted=true # record
    echo "Deleted local file: $file. Deleting from SD..."
    rm "$path"
  fi
done
$deleted || echo "No old files deleted."

# Record in Playlist when last sync occurred
date +%s >> "$mb_folder/sd.log"

